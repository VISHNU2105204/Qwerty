<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="Screenshot 2025-10-22 140606.png" />
  <title>Forgot Password - Truth Detector AI</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Forgot password page specific styles - enhanced styles in styles.css */
    body {
      animation: pageFadeIn 0.6s ease-out;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    
    .center {
      text-align: center;
    }
    
    #otp {
      letter-spacing: 0.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
    }
    
    #resendOtpBtn {
      width: 100%;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('forgotForm');
      const info = document.getElementById('info');
      const submitBtn = document.querySelector('.auth-btn');
      const originalBtnText = submitBtn.textContent;
      let userEmail = '';
      let resetToken = '';

      // Function to show OTP input
      function showOTPInput(email) {
        const formHTML = `
          <div class="auth-field">
            <label class="auth-label" for="otp">Enter OTP</label>
            <input class="auth-input" id="otp" name="otp" type="text" placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}" required />
            <p style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem;">Check your email for the OTP code</p>
          </div>
          <button class="auth-btn" type="submit" id="verifyOtpBtn">Verify OTP</button>
          <button class="auth-btn" type="button" id="resendOtpBtn" style="background: #6b7280; margin-top: 0.5rem;">Resend OTP</button>
        `;
        form.innerHTML = formHTML;
        userEmail = email;

        // Add event listeners for OTP verification
        document.getElementById('verifyOtpBtn').addEventListener('click', verifyOTP);
        document.getElementById('resendOtpBtn').addEventListener('click', resendOTP);
        
        // Focus on OTP input
        document.getElementById('otp').focus();
      }

      // Function to verify OTP
      async function verifyOTP(e) {
        e.preventDefault();
        const otp = document.getElementById('otp').value.trim();
        if (!otp || otp.length !== 6) {
          alert('Please enter a valid 6-digit OTP.');
          return;
        }

        const verifyBtn = document.getElementById('verifyOtpBtn');
        const originalText = verifyBtn.textContent;
        verifyBtn.textContent = 'Verifying...';
        verifyBtn.disabled = true;

        try {
          const response = await fetch('/api/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, otp: otp })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            resetToken = data.reset_token;
            // Redirect to reset password page with token
            window.location.href = `reset-password.html?token=${resetToken}`;
          } else {
            alert(data.error || 'Invalid OTP. Please try again.');
            document.getElementById('otp').value = '';
            document.getElementById('otp').focus();
          }
        } catch (error) {
          console.error('Verify OTP error:', error);
          alert('Failed to verify OTP. Please try again.');
        } finally {
          verifyBtn.textContent = originalText;
          verifyBtn.disabled = false;
        }
      }

      // Function to resend OTP
      async function resendOTP(e) {
        e.preventDefault();
        const resendBtn = document.getElementById('resendOtpBtn');
        const originalText = resendBtn.textContent;
        resendBtn.textContent = 'Sending...';
        resendBtn.disabled = true;

        try {
          const response = await fetch('/api/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });

          const data = await response.json();

          if (response.ok) {
            info.textContent = 'New OTP has been sent to your email.';
            info.style.display = 'block';
            // For development, show OTP in console/alert
            if (data.otp) {
              console.log('OTP (for development):', data.otp);
              // Show OTP more prominently as "Development OTP"
              info.innerHTML += '<br><br><div style="padding: 20px; background: #fffbeb; border-radius: 12px; border: 2px solid #fbbf24; margin-top: 20px; text-align: center;">' +
                               '<div style="font-weight: bold; color: #92400e; font-size: 1.2rem; margin-bottom: 15px;">⚙️ DEVELOPMENT OTP</div>' +
                               '<div style="font-size: 2.5rem; letter-spacing: 0.8rem; font-weight: bold; color: #92400e; margin: 15px 0;">' + data.otp + '</div>' +
                               '<div style="font-size: 0.9rem; color: #92400e; margin-top: 10px; font-style: italic;">Copy this code and paste it in the OTP field below</div>' +
                               '</div>';
            }
            document.getElementById('otp').value = '';
            document.getElementById('otp').focus();
          } else {
            alert(data.error || 'Failed to resend OTP.');
          }
        } catch (error) {
          console.error('Resend OTP error:', error);
          alert('Failed to resend OTP. Please try again.');
        } finally {
          resendBtn.textContent = originalText;
          resendBtn.disabled = false;
        }
      }

      // Initial form submission to send OTP
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        if (!email) {
          alert('Please enter your email.');
          return;
        }

        // Show loading state
        submitBtn.textContent = 'Sending OTP...';
        submitBtn.disabled = true;

        try {
          const response = await fetch('/api/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            info.textContent = data.message;
            info.style.display = 'block';
            
            // For development, show OTP in console/alert
            if (data.otp) {
              console.log('OTP (for development):', data.otp);
              // Show OTP more prominently as "Development OTP"
              info.innerHTML += '<br><br><div style="padding: 20px; background: #fffbeb; border-radius: 12px; border: 2px solid #fbbf24; margin-top: 20px; text-align: center;">' +
                               '<div style="font-weight: bold; color: #92400e; font-size: 1.2rem; margin-bottom: 15px;">⚙️ DEVELOPMENT OTP</div>' +
                               '<div style="font-size: 2.5rem; letter-spacing: 0.8rem; font-weight: bold; color: #92400e; margin: 15px 0;">' + data.otp + '</div>' +
                               '<div style="font-size: 0.9rem; color: #92400e; margin-top: 10px; font-style: italic;">Copy this code and paste it in the OTP field below</div>' +
                               '</div>';
            }

            // Show OTP input form after a longer delay to allow user to see the OTP
            setTimeout(() => {
              showOTPInput(email);
            }, 8000); // Increased to 8 seconds for better visibility
          } else {
            alert(data.error || 'Failed to send OTP.');
            submitBtn.textContent = originalBtnText;
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error('Forgot password error:', error);
          alert('Failed to send OTP. Please try again.');
          submitBtn.textContent = originalBtnText;
          submitBtn.disabled = false;
        }
      });
    });
  </script>
  <script src="navigation-interceptor.js"></script>
</head>

<body>
  <div class="auth-hero">
    <a href="index.html" style="text-decoration: none; color: inherit;">
      <h1>Forgot your password?</h1>
    </a>
    <p>We'll send you an OTP to reset your password.</p>
  </div>
  <div class="auth-wrapper">
    <div class="auth-card">
      <a class="nav-home" href="login.html">← Back to Login</a>
      <p class="auth-sub">Enter the email you use for Truth Detector AI</p>
      <form id="forgotForm">
        <div class="auth-field">
          <label class="auth-label" for="email">Email</label>
          <input class="auth-input" id="email" name="email" type="email" placeholder="you@example.com" required />
        </div>
        <button class="auth-btn" type="submit">Send OTP</button>
      </form>
      <p id="info" class="auth-footer" style="display:none"></p>
      <p class="auth-footer center">Remembered it? <a class="auth-link" href="login.html">Login</a></p>
    </div>
  </div>
</body>
</html>